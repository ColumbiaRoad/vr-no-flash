(function(e){"use strict";$('<style type="text/css">'+"#nf-coaches svg { pointer-events: none; }"+"#flashPageDiv, object, .loadflash, .infoBoxCoachMap { display: none }"+'#ResEnq_0_true:after { content: " ❤"}'+".boxy-inner.nf-boxy { background: #ddd}"+"#nf-loader-prev, #nf-loader-next { margin: 20px auto; display: block; }"+"#nf-coaches svg { padding: 0 1.5em 20px; width: 800px; }"+"#nf-coaches>div { background: #fff; border-radius: 5px; margin: 10px; width:830px }"+"#nf-coaches h2 { font: bold 24px Arial; padding: 20px 10px 0 30px; margin: 0; }"+"#nf-coaches h2 span { font: normal 16px Arial; font-style: italic; color: #555; padding-left: 1em; }"+"#nf-buttons { padding: 0 10px 35px 6px; }"+"#nf-buttons span.btnGreen { float:right; }"+"</style>").appendTo("head");var t=$('script[src*="/nf.js"], script[src*="/nf.min.js"]').attr("src").replace(/nf\.(min\.)?js.*/,"");var a={};e.console=e.console||{};console.log=console.log||function(){};e.loadFlash=function(){var n={};var r={};var s;var i=parseInt($("#noOfPassengers").val());var o=[];var l=[];var c=0;function f(){var e={prev:false,next:false};$.each(r,function(t,a){if(a===1){e[t.substr(0,4)]=true}});$("#nf-loader-prev").toggle(e.prev);$("#nf-loader-next").toggle(e.next)}function p(e,t){var a=parseInt($("#coachNo",e).val());if(isNaN(a)){return}["prev","next"].forEach(function(s){if(t&&t!=s){return}if($("#"+s+"CoachAvailable",e).val()==="true"&&!(r[s+a]||n[a+(s==="prev"?-1:1)]||r[s+a+(s==="prev"?-2:2)])){r[s+a]=1;var i=$("#seatMapForm").clone();i.find("#coachNo").val(a);i.ajaxSubmit({url:"Reservation_"+s+".do",success:function(e){r[s+a]=2;var t=(new DOMParser).parseFromString(e,"text/html");var n=$("#coachNo",t).val();if(n){u(t,s)}f()}})}});f()}function u(e,t){var a=$("#coachType",e).val();if(!a){console.log("no type?",e,$("#coachType",e));return}var r=$("#coachNo",e).val();var i=$("<div/>");i.attr("data-nf-coach-number",r);s.children().each(function(){if(parseInt($(this).attr("data-nf-coach-number"))>parseInt(r)){i.insertBefore(this);return false}});if(n[r]&&n[r].type){return}n[r]={$dstElem:i,number:r,type:a,title:$("input#coachDescription",e).val(),statusXML:$("input#coachXMLString",e).val()};p(e,t);h(n[r])}var d='<filter id="status-na">'+"</filter>"+'<filter id="status-free">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope=".32"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope=".32"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-taken">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="0"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>"+'<filter id="status-selected">'+"<feComponentTransfer>"+'<feFuncR type="linear" slope="1"/>'+'<feFuncG type="linear" slope="1"/>'+'<feFuncB type="linear" slope="0"/>'+"</feComponentTransfer>"+"</filter>";e.nfDefineCoach=function(e){a[e.type]=e.svg;v()};function v(){l=l.filter(function(e){if(a[e[0]]){e[1]();return false}else{return true}})}function h(n){var r=$("<h2/>").text("VAUNU "+n.number);r.append($("<span/>").text(n.title+" ("+n.type+")"));n.$dstElem.append(r);l.push([n.type,function(){g(n)}]);if(a[n.type]){e.setTimeout(v,1)}else{$.ajaxSetup({cache:true});$.getScript(t+"/coaches/"+n.type+".js");$.ajaxSetup({cache:false})}}function g(e){c++;e.svgId=c;var t=a[e.type].replace(/ width="\w+"/,"").replace(/ height="\w+"/,"").replace(/ id="(?=\w+")/g,' id="c'+e.svgId).replace(/ xlink:href="#(?=\w+")/g,' xlink:href="#c'+e.svgId);if(e.svgId===1){t=t.replace(/<defs>/,"<defs>"+d)}var r=(new DOMParser).parseFromString(t,"text/xml");var s=(new DOMParser).parseFromString(e.statusXML,"text/xml");e.statuses={};$("seat",s).each(function(){var t=$(this);var a=t.find("number").text();if(t.find("selected").text()==="1"){e.statuses[a]="selected";o.push({coach:e.number,seat:a})}else{var n=t.find("status").text();if(n==="0"){e.statuses[a]="free"}else{if(!/^[16]$/.test(n)){console.log("UNKNOWN SEAT STATUS",e.number,a,n)}e.statuses[a]="taken"}}});function l(e){var t;while(t=e.getAttribute("xlink:href")){e=$(t)[0]}$(e).find("*").andSelf().attr("fill","#fff")}r.children[0].id="nf-svg-"+e.svgId;e.$dstElem.append(r.children[0]);e.$dstElem.find("svg").hide().fadeIn();function f(t){return Array.prototype.slice.apply(document.querySelectorAll("svg#nf-svg-"+e.svgId+" "+t))}var p=f('[class="n-floorplan"]')[0];var u=f(p.getAttribute("xlink:href"))[0];u.setAttribute("transform",p.getAttribute("transform"));p.parentNode.removeChild(p);u.parentNode.removeChild(u);f("")[0].appendChild(u);e.drawSeatStatuses=function(t){var a=t?'[class="n-seat_'+t+'"]':'[class^="n-seat_"]';f(a).forEach(function(t){l(t);$(t.getAttribute("xlink:href")).css({cursor:"pointer",pointerEvents:"all"});var a=t.className.baseVal.replace(/^n-seat_/,"");if(a in e.statuses){t.setAttribute("filter","url(#status-"+e.statuses[a]+")")}})};e.drawSeatStatuses();f('[class^="n-seat_"]').forEach(function(t){$(t).click(function(){var t=this.className.baseVal.replace(/^n-seat_/,"");if(e.statuses[t]==="free"){o.push({coach:e.number,seat:t});e.statuses[t]="selected";if(o.length>i){var a=o.shift();n[a.coach].statuses[a.seat]="free";n[a.coach].drawSeatStatuses(a.seat)}e.drawSeatStatuses(t)}})})}s=$('<div id="nf-coaches"/>');s.append($("<div/>").attr("data-nf-coach-number",999));$("#flashPageDiv").after('<img id="nf-loader-prev" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">',s,'<img id="nf-loader-next" src="https://shop.vr.fi/onlineshop/pages/ram/img/loadingAnimation.gif">','<div id="nf-buttons">'+'<span class="btnVR middle btnGreen"><a href="#">Vahvista</a></span>'+'<span class="btnVR middle btnGrey"><a href="#">Peruuta</a></span>'+"</div>");$("#flashPageDiv").closest(".boxy-inner").addClass("nf-boxy");$("#nf-buttons a:first").click(function(){var e=i-o.length;if(e){alert("Valitse vielä "+e+" paikka"+(e>1?"a":""));return}var t=o[0].coach;var a="";o.forEach(function(e){if(t!==e.coach){alert("Valitettavasti tällä virityksellä voi varata paikkoja vain yhdestä vaunusta kerrallaan.");return}a+=",seat_"+e.seat});a=a.replace(/^,/,"");$("#seatMapForm #coachNo").val(t);saveSeatReservations("./Reservation_add.do",a)});$("#nf-buttons a:last").click(function(){$("a.close").trigger("click")});u(document)}})(this);